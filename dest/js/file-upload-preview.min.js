/**
* file-upload-preview 
* @author  Raheel Khan <dronzer92@gmail.com>
* @licence The MIT License (MIT)
* Thu Feb 22 2018 16:57:21
*/

!function(){var a=function(a){if(this.config={selector:null,ajax_src:null,extensions:"jpg|jpeg|png|gif",has_main:!1,has_rotation:!0,max_upload:50,base_url:"",post_file_index:"img_index",post_file_name:"img_name",post_file_rotate:"img_rotate",on_init:null,on_upload:null,on_error:null,on_delete:null,on_rotate:null,on_drop:null,predefined_images:[]},$.extend(this.config,a),!this.config.selector||!this.config.ajax_src)return void alert("Required parameters are not available!");window.file_upload_instense||(window.file_upload_instense=0),window.file_upload_instense++,this.container="imgPrev"+file_upload_instense,this.instense=file_upload_instense,this.config.has_main&&1==this.config.has_main&&$("head").append("<style>#"+this.container+" .imgbox:first-child:after {content: 'Main Picture';background: #337ab7;color: #fff;padding: 0 3px;position: absolute;top: 0;left: 0;border-top-left-radius: 4px;border-bottom-right-radius: 4px;}</style>"),this.allowed_extensions=[],this.allowed_extensions_icons={},this.files_count=0,this.is_uploading=!1,this.is_uploading_count=0,this.set_extensions();var b=this.config.max_upload>1?"multiple":"",c=this.config.has_rotation?"has_rotate":"",d='<button type="button" class="btn btn-primary select_files_btn">\t\tSelect Files\t\t<input type="file" name="hidden_file_input'+file_upload_instense+'" class="hidden_file_input" id="hidden_file_input'+file_upload_instense+'" '+b+'>\t\t</button>\t\t<div id="'+this.container+'" class="fu-imgPrev '+c+'"></div>';if($(this.config.selector).html(d),this.config.predefined_images&&this.config.predefined_images.length>0){this.files_count=this.config.predefined_images.length;for(var e=this.config.predefined_images,f=0;f<e.length;f++){var g=this.append_image(e[f],f,null,!0);$("#"+this.container).append(g),this.config.has_main&&1==this.config.has_main&&this.refresh_drag()}}var h=this;this.apply_remove_image(),$(document).on("click",".btn_rotate",function(a){a.stopImmediatePropagation();var b=$(this).attr("data-type"),c=$(this).parents(".imgbox").find(".img_rotate").val();c=parseInt(c),"left"==b?c-=90:c+=90,$(this).parents(".imgbox").find(".img_rotate").val(c),$(this).parents(".imgbox").find("img").css("transform","rotate("+c+"deg)"),$(this).parents(".imgbox").find("img").css("-ms-transform","rotate("+c+"deg)"),$(this).parents(".imgbox").find("img").css("-webkit-transform","rotate("+c+"deg)"),h.config.on_rotate&&null!=h.config.on_rotate&&h.config.on_rotate()}),document.getElementById("hidden_file_input"+file_upload_instense).addEventListener("change",function(a){h.input_change(a)}),this.config.on_init&&null!=this.config.on_init&&this.config.on_init()};a.prototype.apply_remove_image=function(){for(var a=this,b=document.getElementsByClassName("remove_image"+this.instense),c=0;c<b.length;c++)b[c].addEventListener("click",function(b){$(this).parents(".imgbox").remove(),a.files_count--,a.refresh_index(),a.check_max_upload(),a.config.on_delete&&null!=a.config.on_delete&&a.config.on_delete()})},a.prototype.set_extensions=function(){this.allowed_extensions=[],this.allowed_extensions_icons={};var a=this.config.extensions;if("string"==typeof a){a=a.split("|");for(var b=0;b<a.length;b++)if(a[b].indexOf("->")>0){var c=a[b].split("->"),d=c[0].toLowerCase(),e=c[1];this.allowed_extensions.push(d),this.allowed_extensions_icons[d]=e}else this.allowed_extensions.push(a[b])}else for(var b=0;b<a.length;b++)"object"==typeof a[b]?(this.allowed_extensions.push(a[b].type),a[b].hasOwnProperty("icon")&&(this.allowed_extensions_icons[a[b].type]=a[b].icon)):this.allowed_extensions.push(a[b])},a.prototype.input_change=function(a){this.set_is_uploading(!0);for(var b=0;b<a.target.files.length;b++){if(this.check_max_upload())return;var c=new FormData;c.append("upload_files",a.target.files[b]);var d=a.target.files[b].name,e=d.split(".");e=e[e.length-1],-1==this.allowed_extensions.indexOf(e)?(this.set_is_uploading(),alert("File type ."+e+" is not allowed")):(this.uploadFiles(c,this.files_count),this.files_count++)}},a.prototype.uploadFiles=function(a,b){var c=this;$("#"+c.container).append('<div class="imgbox imgbox-loading-'+b+'"><i class="fa fa-refresh fa-spin"></i></div>'),$.ajax({url:this.config.ajax_src,cache:!1,contentType:!1,processData:!1,type:"post",data:a,success:function(a){var d=!1;$(".imgbox-loading-"+b).remove();try{a=JSON.parse(a)}catch(a){console.log(a)}var e="";a&&"object"==typeof a?a.error?e='<div class="imgbox imgbox-error" data-index="'+b+'">'+a.message+"</div>":(e=c.append_image(a.name,b,c.config.base_url),d=!0):e='<div class="imgbox imgbox-error" data-index="'+b+'"><i class="fa fa-exclamation-triangle"></i></div>',$("#"+c.container).append(e),c.config.has_main&&1==c.config.has_main&&c.refresh_drag(),c.apply_remove_image(),c.check_max_upload(),c.set_is_uploading(),d&&c.config.on_upload&&null!=c.config.on_upload?c.config.on_upload(a.name):c.config.on_error&&null!=c.config.on_error&&c.config.on_error()}})},a.prototype.append_image=function(a,b,c,d){c=c&&""!=c?c:"";var e=a.split(".");e=e[e.length-1];var f="";if(this.allowed_extensions_icons.hasOwnProperty(e)){var g=this.allowed_extensions_icons[e];f=0==g.indexOf("[")&&g.lastIndexOf("]")==g.length-1?g.slice(1,-1):0==g.indexOf("<")&&g.lastIndexOf(">")==g.length-1?g:'<img src="'+g+'" alt="">'}else f='<img src="'+c+a+'" alt="">',this.config.has_rotation&&(f+='<button type="button" class="btn_rotate" data-type="left"><i class="fa fa-undo"></i></button>\t\t\t\t\t<button type="button" class="btn_rotate" data-type = "right"><i class = "fa fa-repeat"></i></button>');var h=d?"uploaded:":"";return'<div class="imgbox" data-index="'+b+'">\t\t\t<input type="hidden" class="img_index" name="'+this.config.post_file_index+"["+b+']" value = "'+b+'" >\t\t<input type="hidden" class="img_name" name="'+this.config.post_file_name+"["+b+']" value = "'+h+c+a+'" >\t\t<input type="hidden" class="img_rotate" name="'+this.config.post_file_rotate+"["+b+']" value = "0" >\t\t'+f+'\t\t<button type="button" class="remove_image remove_image'+this.instense+'" > <i class="fa fa-times"></i></button>\t\t</div>'},a.prototype.check_max_upload=function(){return this.files_count>=this.config.max_upload?($(this.config.selector).find(".select_files_btn").attr("disabled",!0),$(this.config.selector).find(".hidden_file_input").hide(),!0):($(this.config.selector).find(".select_files_btn").attr("disabled",!1),$(this.config.selector).find(".hidden_file_input").show(),!1)},a.prototype.refresh_drag=function(){var a=this;$("#"+a.container).disableSelection(),$("#"+a.container).sortable({placeholder:"sortable-placeholder",update:function(b,c){a.refresh_index(),a.config.on_drop&&null!=a.config.on_drop&&a.config.on_drop()}})},a.prototype.refresh_index=function(){var a=this;$("#"+a.container+" .imgbox").each(function(b){$(this).attr("data-index",b),$(this).find(".img_index").val(b),$(this).find(".img_index").attr("name",a.config.post_file_index+"["+b+"]"),$(this).find(".img_name").attr("name",a.config.post_file_name+"["+b+"]"),$(this).find(".img_rotate").attr("name",a.config.post_file_rotate+"["+b+"]")})},a.prototype.set_is_uploading=function(a){a?this.check_max_upload()||(this.is_uploading_count=this.files_count+event.target.files.length,this.is_uploading=!0,window.onbeforeunload=function(){return"Some files are still getting uploaded. Taking this page away will terminate all the ongoing uploading."}):this.files_count>=this.is_uploading_count-1&&(this.is_uploading=!1,this.is_uploading_count=0,window.onbeforeunload=null)},window.file_upload_preview=a}();